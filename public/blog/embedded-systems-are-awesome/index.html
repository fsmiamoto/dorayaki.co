<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=35709&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Embedded Systems are awesome! | Dorayaki</title>
<meta name="keywords" content="">
<meta name="description" content="I&rsquo;ve just finished my class of Embedded Systems in my university and
I have to say, it was an awesome experience.
As a guy that really likes low level stuff, understanding how a micro controller
works internally to get to the point of running an actual Real Time Operating System (RTOS)
was really enjoyable.
Let&rsquo;s go through some of things you can learn while studying Embedded Systems :D
Bare Metal?
We all have to start somewhere and that&rsquo;s bare metal, running code without
an actual operating system behind it.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:35709/blog/embedded-systems-are-awesome/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.45e028aa8ce0961349adf411b013ee39406be2c0bc80d4ea3fc04555f7f4611a.css" integrity="sha256-ReAoqozglhNJrfQRsBPuOUBr4sC8gNTqP8BFVff0YRo=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:35709/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:35709/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:35709/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:35709/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:35709/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:35709/blog/embedded-systems-are-awesome/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:35709/" accesskey="h" title="Dorayaki (Alt + H)">Dorayaki</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:35709/posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Embedded Systems are awesome!
    </h1>
    <div class="post-meta"><span title='2021-09-04 00:00:00 +0000 UTC'>September 4, 2021</span>

</div>
  </header> 
  <div class="post-content"><p>I&rsquo;ve just finished my class of Embedded Systems in my university and
I have to say, it was an awesome experience.</p>
<p>As a guy that really likes low level stuff, understanding how a micro controller
works internally to get to the point of running an actual Real Time Operating System (RTOS)
was really enjoyable.</p>
<p>Let&rsquo;s go through some of things you can learn while studying Embedded Systems :D</p>
<h2 id="bare-metal">Bare Metal?<a hidden class="anchor" aria-hidden="true" href="#bare-metal">#</a></h2>
<p>We all have to start somewhere and that&rsquo;s bare metal, running code without
an actual operating system behind it.</p>
<p>In this case you get to understand how the internal peripherals of the chip need to be
configured for some desired clock frequency, how to enable GPIO pins and even how
interrupts need to be handled.</p>
<p>As an example of what it looks like, the code below shows a simple finite state machine
that goes through a Gray count and showing the count on the board&rsquo;s builtin LEDs:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdint.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdbool.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;driverlib/systick.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;driverleds.h&#34; </span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define SYSTICK_ONE_SEC_24MHZ_CLK 12000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">enum</span> {
</span></span><span style="display:flex;"><span>  COUNT_000 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>  COUNT_001 <span style="color:#f92672">=</span> LED3,
</span></span><span style="display:flex;"><span>  COUNT_011 <span style="color:#f92672">=</span> LED2 <span style="color:#f92672">|</span> LED3,
</span></span><span style="display:flex;"><span>  COUNT_010 <span style="color:#f92672">=</span> LED2,
</span></span><span style="display:flex;"><span>  COUNT_110 <span style="color:#f92672">=</span> LED1 <span style="color:#f92672">|</span> LED2,
</span></span><span style="display:flex;"><span>  COUNT_111 <span style="color:#f92672">=</span> LED1 <span style="color:#f92672">|</span> LED2 <span style="color:#f92672">|</span> LED3,
</span></span><span style="display:flex;"><span>  COUNT_101 <span style="color:#f92672">=</span> LED1 <span style="color:#f92672">|</span> LED3,
</span></span><span style="display:flex;"><span>  COUNT_100 <span style="color:#f92672">=</span> LED1,
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">state_t</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">uint8_t</span> tick <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">state_t</span> state;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">SysTick_Handler</span>(<span style="color:#66d9ef">void</span>){
</span></span><span style="display:flex;"><span>  tick <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setUp</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">LEDInit</span>(LED1 <span style="color:#f92672">|</span> LED2 <span style="color:#f92672">|</span> LED3);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">SysTickPeriodSet</span>(SYSTICK_ONE_SEC_24MHZ_CLK);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">SysTickIntEnable</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">SysTickEnable</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>){
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setUp</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  state <span style="color:#f92672">=</span> COUNT_000; 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(;;){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(tick){
</span></span><span style="display:flex;"><span>      tick <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">switch</span>(state){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> COUNT_000:
</span></span><span style="display:flex;"><span>          state <span style="color:#f92672">=</span> COUNT_001;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> COUNT_001:
</span></span><span style="display:flex;"><span>          state <span style="color:#f92672">=</span> COUNT_011;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> COUNT_011:
</span></span><span style="display:flex;"><span>          state <span style="color:#f92672">=</span> COUNT_010;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> COUNT_010:
</span></span><span style="display:flex;"><span>          state <span style="color:#f92672">=</span> COUNT_110;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> COUNT_110:
</span></span><span style="display:flex;"><span>          state <span style="color:#f92672">=</span> COUNT_111;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> COUNT_111:
</span></span><span style="display:flex;"><span>          state <span style="color:#f92672">=</span> COUNT_101;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> COUNT_101:
</span></span><span style="display:flex;"><span>          state <span style="color:#f92672">=</span> COUNT_100;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> COUNT_100:
</span></span><span style="display:flex;"><span>          state <span style="color:#f92672">=</span> COUNT_000;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      } 
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">LEDOn</span>(state);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">LEDOff</span>(<span style="color:#f92672">~</span>state);
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>  } 
</span></span><span style="display:flex;"><span>} 
</span></span></code></pre></div><p>Full code available <a href="https://github.com/fsmiamoto/TM4C1294_Bare_IAR9/tree/main/Projects/Laborat%C3%B3rio_03">here</a></p>
<p>Well, it isn&rsquo;t much but it&rsquo;s a good staring point!</p>
<p>In this we had to <em>manually</em> initiate the hardware and enable interrupts - mostly in the <code>setUp</code> function -
calling the appropriate functions made available by the chip vendor, Texas Instruments in
this case.</p>
<p>Developing a bare metal solution can be all you need depending on the application but once
we need to have <strong>concurrent</strong> tasks, having to do it from scratch can get really difficult.</p>
<p>That&rsquo;s when a Real Time Operating System (RTOS) comes in handy.</p>
<h2 id="real-time">Real Time?<a hidden class="anchor" aria-hidden="true" href="#real-time">#</a></h2>
<p>To start, what does exactly <em>Real Time</em> mean in here?</p>
<p>Simply put, it means that tasks executing on a RTOS have a <strong>deadline</strong> and with that a
very important separation appears between <strong>soft</strong> and <strong>hard</strong> real time systems.</p>
<h3 id="hard-and-soft">Hard and Soft<a hidden class="anchor" aria-hidden="true" href="#hard-and-soft">#</a></h3>
<p>Although these definitions might have some room for different interpretations, the
following describe the general idea:</p>
<ul>
<li><strong>Hard real time</strong>: systems that have <strong>serious consequences</strong> when deadlines are not respected - usually involving human injuries.</li>
<li><strong>Soft real time</strong>: systems that <strong>might tolerate</strong> missing some deadlines, even though it is not
desirable.</li>
</ul>
<p>An example for a hard real time system is one that controls a safety critical system such
as ABS.</p>
<p>For soft real time, we can consider applications such as video streaming where not hitting
the deadlines might cause some stutter but no one get&rsquo;s harmed with that, right?</p>
<blockquote>
<p>Ok, maybe the remote control might get thrown at the TV but still, no human injuries are
expected :)</p></blockquote>
<p>But how do we manage running tasks in a real time OS?</p>
<p>For most embedded applications you might only have a single computing core so the task
becomes even more interesting.</p>
<p>With that, we need to get into <em>concurrency controls</em> and <em>scheduling algorithms</em>, two operating
systems topics that I really like!</p>
<p>Both are huge topics but you&rsquo;ll definitely need to remember all those things from your
Operating Systems class, including semaphores, mutexes, message queues, task priority,
starvation and much more :D</p>
<h2 id="first-rtos-example">First RTOS example<a hidden class="anchor" aria-hidden="true" href="#first-rtos-example">#</a></h2>
<p>Let&rsquo;s start with a simple example, just blinking 4 LEDs at different
frequencies.</p>
<p>In this example, we create 4 threads - one for each LED - which has a <em>body</em> that simply
switches a particular LED on and off and waits for the given amount of time.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;cmsis_os2.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;driverleds.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;system_tm4c1294.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">osThreadId_t</span> thread_id;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint8_t</span> led_number;         <span style="color:#75715e">// One of LED1, LED2, LED3, LED4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">uint32_t</span> activation_period; <span style="color:#75715e">// Number of system ticks
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>} <span style="color:#66d9ef">led_blink_t</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define NUM_OF_BLINKERS sizeof(blinkers)/sizeof(led_blink_t)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">led_blink_t</span> blinkers[] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    {.led_number <span style="color:#f92672">=</span> LED1, .activation_period <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>},
</span></span><span style="display:flex;"><span>    {.led_number <span style="color:#f92672">=</span> LED2, .activation_period <span style="color:#f92672">=</span> <span style="color:#ae81ff">300</span>},
</span></span><span style="display:flex;"><span>    {.led_number <span style="color:#f92672">=</span> LED3, .activation_period <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>},
</span></span><span style="display:flex;"><span>    {.led_number <span style="color:#f92672">=</span> LED4, .activation_period <span style="color:#f92672">=</span> <span style="color:#ae81ff">700</span>},
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">blinker</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>arg) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint8_t</span> state <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint32_t</span> tick;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">led_blink_t</span> <span style="color:#f92672">*</span>b <span style="color:#f92672">=</span> (<span style="color:#66d9ef">led_blink_t</span> <span style="color:#f92672">*</span>)arg;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (;;) {
</span></span><span style="display:flex;"><span>    tick <span style="color:#f92672">=</span> <span style="color:#a6e22e">osKernelGetTickCount</span>();
</span></span><span style="display:flex;"><span>    state <span style="color:#f92672">^=</span> b<span style="color:#f92672">-&gt;</span>led_number;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">LEDWrite</span>(b<span style="color:#f92672">-&gt;</span>led_number, state);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">osDelayUntil</span>(tick <span style="color:#f92672">+</span> b<span style="color:#f92672">-&gt;</span>activation_period);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">LEDInit</span>(LED1 <span style="color:#f92672">|</span> LED2 <span style="color:#f92672">|</span> LED3 <span style="color:#f92672">|</span> LED4);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">osKernelInitialize</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> NUM_OF_BLINKERS; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    blinkers[i].thread_id <span style="color:#f92672">=</span> <span style="color:#a6e22e">osThreadNew</span>(blinker, <span style="color:#f92672">&amp;</span>blinkers[i], NULL);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">osKernelGetState</span>() <span style="color:#f92672">==</span> osKernelReady)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">osKernelStart</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// NOT REACHED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    ;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Full code available <a href="https://github.com/fsmiamoto/TM4C1294_RTOS_IAR9/blob/main/Projects/Lab04/src/main.c">here</a></p>
<p>Here we can already see the advantages of using a RTOS since we don&rsquo;t need
to think too much about how the tasks will be scheduled on the CPU (not for this simple
one at least).</p>
<p>But now let&rsquo;s see a more elaborate example, where a RTOS can <strong>really</strong> shine.</p>
<h2 id="pwming-4-leds-concurrently">PWM&rsquo;ing 4 LEDs concurrently<a hidden class="anchor" aria-hidden="true" href="#pwming-4-leds-concurrently">#</a></h2>
<p>In this final example, we&rsquo;ll have the same 4 threads managing one LED but this time using
<a href="https://en.wikipedia.org/wiki/Pulse-width_modulation">Pulse Width Modulation</a> (PWM).
The threads read from a <em>message queue</em> that signals whether the duty cycle should increase.</p>
<p>Messages are queued by a <strong>manager</strong> thread which also receives messages from a queue
that signals that the development board built-in push button was pressed.</p>
<p>There&rsquo;s a set number of steps, after which the duty cycle goes back to the lowest possible
value.</p>
<p>The architecture of the code can be seen below:
<img alt="Architecture" loading="lazy" src="https://raw.githubusercontent.com/fsmiamoto/TM4C1294_RTOS_IAR9/main/Projects/Lab06/diagramas/architecture.png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;cmsis_os2.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;driverbuttons.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;driverleds.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;pwm.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;system_TM4C1294.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdint.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define LEDs LED1 | LED2 | LED3 | LED4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define NUM_OF_WORKERS (sizeof(workers) / sizeof(worker_t))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define WORKER_QUEUE_SIZE 8U
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MANAGER_QUEUE_SIZE 8U
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define DEBOUNCE_TICKS 300U
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define NO_WAIT 0U
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MSG_PRIO 0U
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define PWM_PERIOD 10U   </span><span style="color:#75715e">// ms
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define BLINK_PERIOD 50U </span><span style="color:#75715e">// ms
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Push buttons are active in 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define ButtonPressed(b) !ButtonRead(b)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define notifySelectedWorker()                                                 \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  osMessageQueuePut(workers[selected_worker].args.queue_id, &amp;notification,     \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                    MSG_PRIO, osWaitForever)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">enum</span> {
</span></span><span style="display:flex;"><span>  SW1_PRESSED,
</span></span><span style="display:flex;"><span>  SW2_PRESSED,
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">button_event_t</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Notification to workers, no content needed.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">uint8_t</span> <span style="color:#66d9ef">manager_notif_t</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// worker_args_t represents the arguments for a worker thread
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">osMessageQueueId_t</span> queue_id;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint8_t</span> led_number; <span style="color:#75715e">// One of LED1, LED2, LED3 and LED4.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">uint16_t</span> on_time;   <span style="color:#75715e">// In ms
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">uint16_t</span> period;    <span style="color:#75715e">// In ms
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>} <span style="color:#66d9ef">worker_args_t</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// worker_t represents a worker thread and it&#39;s arguments
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">osThreadId_t</span> thread_id;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">worker_args_t</span> args;
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">worker_t</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// manager_t represents a manager thread
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">osThreadId_t</span> thread_id;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">osMessageQueueId_t</span> queue_id;
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">manager_t</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">osMutexId_t</span> led_mutex_id;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">osMutexAttr_t</span> led_mutex_attr <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;LEDMutex&#34;</span>, osMutexPrioInherit, NULL, <span style="color:#ae81ff">0U</span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">manager_t</span> manager;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">worker_t</span> workers[] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    {.args <span style="color:#f92672">=</span> {.led_number <span style="color:#f92672">=</span> LED1, .period <span style="color:#f92672">=</span> BLINK_PERIOD, .on_time <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>}},
</span></span><span style="display:flex;"><span>    {.args <span style="color:#f92672">=</span> {.led_number <span style="color:#f92672">=</span> LED2, .period <span style="color:#f92672">=</span> PWM_PERIOD, .on_time <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>}},
</span></span><span style="display:flex;"><span>    {.args <span style="color:#f92672">=</span> {.led_number <span style="color:#f92672">=</span> LED3, .period <span style="color:#f92672">=</span> PWM_PERIOD, .on_time <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>}},
</span></span><span style="display:flex;"><span>    {.args <span style="color:#f92672">=</span> {.led_number <span style="color:#f92672">=</span> LED4, .period <span style="color:#f92672">=</span> PWM_PERIOD, .on_time <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>}},
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">initializeHardware</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">osKernelInitialize</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">initializeManager</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">initializeWorkers</span>();
</span></span><span style="display:flex;"><span>  led_mutex_id <span style="color:#f92672">=</span> <span style="color:#a6e22e">osMutexNew</span>(<span style="color:#f92672">&amp;</span>led_mutex_attr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">osKernelGetState</span>() <span style="color:#f92672">==</span> osKernelReady)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">osKernelStart</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// NOT REACHED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    ;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Manager is the body of the manager thread.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// It receives events through a queue and notifies
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// workers that need to update their values.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Manager</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>arg) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">button_event_t</span> event;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">manager_notif_t</span> notification;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint8_t</span> selected_worker <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (;;) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">osMessageQueueGet</span>(manager.queue_id, <span style="color:#f92672">&amp;</span>event, NULL, osWaitForever);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> (event) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> SW1_PRESSED:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// We need to restore the PWM period of the current selected worker
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      workers[selected_worker].args.period <span style="color:#f92672">=</span> PWM_PERIOD;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">notifySelectedWorker</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      selected_worker <span style="color:#f92672">=</span> (selected_worker <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> NUM_OF_WORKERS;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      workers[selected_worker].args.period <span style="color:#f92672">=</span> BLINK_PERIOD;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">notifySelectedWorker</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> SW2_PRESSED:
</span></span><span style="display:flex;"><span>      workers[selected_worker].args.on_time <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (workers[selected_worker].args.on_time <span style="color:#f92672">&gt;</span> PWM_PERIOD)
</span></span><span style="display:flex;"><span>        workers[selected_worker].args.on_time <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">notifySelectedWorker</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Worker is the body of worker threads.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// It polls for notifications from the manager thread and
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// updates it&#39;s argument values if needed.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Worker</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>arg) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">worker_args_t</span> <span style="color:#f92672">*</span>args <span style="color:#f92672">=</span> (<span style="color:#66d9ef">worker_args_t</span> <span style="color:#f92672">*</span>)arg;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">manager_notif_t</span> notification;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">osStatus_t</span> status;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">osMessageQueueId_t</span> queue_id <span style="color:#f92672">=</span> args<span style="color:#f92672">-&gt;</span>queue_id;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint8_t</span> led_number <span style="color:#f92672">=</span> args<span style="color:#f92672">-&gt;</span>led_number;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint8_t</span> on_time <span style="color:#f92672">=</span> args<span style="color:#f92672">-&gt;</span>on_time;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint16_t</span> period <span style="color:#f92672">=</span> args<span style="color:#f92672">-&gt;</span>period;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (;;) {
</span></span><span style="display:flex;"><span>    status <span style="color:#f92672">=</span> <span style="color:#a6e22e">osMessageQueueGet</span>(queue_id, <span style="color:#f92672">&amp;</span>notification, NULL, NO_WAIT);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (status <span style="color:#f92672">==</span> osOK) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Notification received, update values
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      on_time <span style="color:#f92672">=</span> args<span style="color:#f92672">-&gt;</span>on_time;
</span></span><span style="display:flex;"><span>      period <span style="color:#f92672">=</span> args<span style="color:#f92672">-&gt;</span>period;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">SwitchOn</span>(led_number);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">osDelay</span>(on_time);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">SwitchOff</span>(led_number);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">osDelay</span>(period <span style="color:#f92672">-</span> on_time);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">GPIOJ_Handler</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Used for debouncing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint32_t</span> tick_last_msg_sw1, tick_last_msg_sw2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ButtonIntClear</span>(USW1 <span style="color:#f92672">|</span> USW2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">ButtonPressed</span>(USW1)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((<span style="color:#a6e22e">osKernelGetTickCount</span>() <span style="color:#f92672">-</span> tick_last_msg_sw1) <span style="color:#f92672">&lt;</span> DEBOUNCE_TICKS)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">button_event_t</span> event <span style="color:#f92672">=</span> SW1_PRESSED;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">osStatus_t</span> status <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">osMessageQueuePut</span>(manager.queue_id, <span style="color:#f92672">&amp;</span>event, MSG_PRIO, NO_WAIT);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (status <span style="color:#f92672">==</span> osOK)
</span></span><span style="display:flex;"><span>      tick_last_msg_sw1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">osKernelGetTickCount</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">ButtonPressed</span>(USW2)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((<span style="color:#a6e22e">osKernelGetTickCount</span>() <span style="color:#f92672">-</span> tick_last_msg_sw2) <span style="color:#f92672">&lt;</span> DEBOUNCE_TICKS)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">button_event_t</span> event <span style="color:#f92672">=</span> SW2_PRESSED;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">osStatus_t</span> status <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">osMessageQueuePut</span>(manager.queue_id, <span style="color:#f92672">&amp;</span>event, MSG_PRIO, NO_WAIT);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (status <span style="color:#f92672">==</span> osOK)
</span></span><span style="display:flex;"><span>      tick_last_msg_sw2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">osKernelGetTickCount</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SwitchOn switches on a led in a thread-safe manner
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">SwitchOn</span>(<span style="color:#66d9ef">uint8_t</span> led) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">osMutexAcquire</span>(led_mutex_id, osWaitForever);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">LEDOn</span>(led);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">osMutexRelease</span>(led_mutex_id);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SwitchOff switches off a led in a thread-safe manner
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">SwitchOff</span>(<span style="color:#66d9ef">uint8_t</span> led) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">osMutexAcquire</span>(led_mutex_id, osWaitForever);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">LEDOff</span>(led);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">osMutexRelease</span>(led_mutex_id);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initializeHardware</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">LEDInit</span>(LEDs);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ButtonInit</span>(USW1 <span style="color:#f92672">|</span> USW2);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ButtonIntEnable</span>(USW1 <span style="color:#f92672">|</span> USW2);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initializeWorkers</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> NUM_OF_WORKERS; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    workers[i].args.queue_id <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">osMessageQueueNew</span>(WORKER_QUEUE_SIZE, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">manager_notif_t</span>), NULL);
</span></span><span style="display:flex;"><span>    workers[i].thread_id <span style="color:#f92672">=</span> <span style="color:#a6e22e">osThreadNew</span>(Worker, <span style="color:#f92672">&amp;</span>workers[i].args, NULL);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initializeManager</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>  manager.thread_id <span style="color:#f92672">=</span> <span style="color:#a6e22e">osThreadNew</span>(Manager, NULL, NULL);
</span></span><span style="display:flex;"><span>  manager.queue_id <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">osMessageQueueNew</span>(MANAGER_QUEUE_SIZE, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">button_event_t</span>), NULL);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>For this example we can see the use of some concurrency control mechanisms such as the
mutex, used from controlling the access to the underlying register that sets the LEDs on
or off.</p>
<p>The messaging between threads is another key mechanism for communicating between code
running concurrently and that we get &lsquo;for free&rsquo; when using a RTOS.</p>
<h2 id="final-thoughts">Final thoughts<a hidden class="anchor" aria-hidden="true" href="#final-thoughts">#</a></h2>
<p>Although I don&rsquo;t have any professional experience dealing with Embedded Systems, the low
level nature of coding in this environment is something I <strong>really</strong> enjoy and I hope I
was able to show some of this excitement to you.</p>
<p>Cheers!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:35709/">Dorayaki</a></span>  

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
